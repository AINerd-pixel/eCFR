<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eCFR Agencies Directory</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .agency-card {
            transition: all 0.3s ease;
        }
        .agency-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(62, 54, 54, 0.1);
        }
        .cfr-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .search-input:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const API_BASE_URL = 'http://0.0.0.0:8000';

        // API service for fetching agencies and word counts
        const apiService = {
            getAgencies: async (slug = '', name = '') => {
                try {
                    const params = new URLSearchParams();
                    if (slug) params.append('slug', slug);
                    if (name) params.append('name', name);
                    
                    const response = await axios.get(`${API_BASE_URL}/agencies?${params.toString()}`);
                    return response.data;
                } catch (error) {
                    console.error('Error fetching agencies:', error);
                    throw error;
                }
            },
            
            getWordCount: async (title, chapterIdentifier) => {
                try {
                    const response = await axios.get(`${API_BASE_URL}/word-count/${title}/${chapterIdentifier}`);
                    return response.data;
                } catch (error) {
                    console.error(`Error fetching word count for title ${title}, chapter ${chapterIdentifier}:`, error);
                    return null;
                }
            },
            
            getWordCountsByTitle: async (title) => {
                try {
                    const response = await axios.get(`${API_BASE_URL}/word-counts/${title}`);
                    return response.data;
                } catch (error) {
                    console.error(`Error fetching word counts for title ${title}:`, error);
                    return null;
                }
            },
            
            getAISummary: async (agency) => {
                try {
                    const response = await axios.post(`${API_BASE_URL}/ai/agency-summary`, {
                        agency_name: agency.name,
                        agency_display_name: agency.display_name,
                        cfr_references: agency.cfr_references || [],
                        description: agency.description
                    });
                    return response.data;
                } catch (error) {
                    console.error('Error fetching AI summary:', error);
                    return null;
                }
            }
        };

        // Agency Card Component
        const AgencyCard = ({ agency }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const [wordCounts, setWordCounts] = useState({});
            const [loadingWordCounts, setLoadingWordCounts] = useState(false);
            const [aiSummary, setAiSummary] = useState(null);
            const [loadingAISummary, setLoadingAISummary] = useState(false);
            
            // Calculate aggregated word count totals
            const aggregatedTotals = useMemo(() => {
                const totals = {
                    totalWords: 0,
                    totalCharacters: 0,
                    chaptersWithData: 0,
                    totalChapters: 0,
                    reservedChapters: 0
                };
                
                Object.values(wordCounts).forEach(wordCount => {
                    if (wordCount) {
                        totals.totalWords += wordCount.word_count || 0;
                        totals.totalCharacters += wordCount.character_count || 0;
                        totals.chaptersWithData += 1;
                        if (wordCount.is_reserved) {
                            totals.reservedChapters += 1;
                        }
                    }
                });
                
                // Count total chapters from CFR references
                if (agency.cfr_references) {
                    totals.totalChapters = agency.cfr_references.filter(ref => ref.chapter).length;
                }
                
                return totals;
            }, [wordCounts, agency.cfr_references]);

            // Fetch word counts and AI summary when expanded
            useEffect(() => {
                if (isExpanded) {
                    if (agency.cfr_references && agency.cfr_references.length > 0) {
                        fetchWordCounts();
                    }
                    fetchAISummary();
                }
            }, [isExpanded]);
            
            const fetchWordCounts = async () => {
                setLoadingWordCounts(true);
                const counts = {};
                
                for (const ref of agency.cfr_references) {
                    if (ref.title && ref.chapter) {
                        const wordCount = await apiService.getWordCount(ref.title, ref.chapter);
                        if (wordCount) {
                            const key = `${ref.title}-${ref.chapter}`;
                            counts[key] = wordCount;
                        }
                    }
                }
                
                setWordCounts(counts);
                setLoadingWordCounts(false);
            };
            
            const fetchAISummary = async () => {
                setLoadingAISummary(true);
                const summary = await apiService.getAISummary(agency);
                setAiSummary(summary);
                setLoadingAISummary(false);
            };

            return (
                <div className="agency-card bg-white rounded-lg shadow-md p-6 mb-4 border border-gray-200">
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex-1">
                            <h3 className="text-xl font-bold text-gray-900 mb-2">
                                {agency.display_name || agency.name}
                            </h3>
                            <p className="text-sm text-gray-600 mb-2">
                                <span className="font-medium">Slug:</span> {agency.slug}
                            </p>
                            {agency.display_name && agency.display_name !== agency.name && (
                                <p className="text-sm text-gray-500">
                                    <span className="font-medium">Official Name:</span> {agency.name}
                                </p>
                            )}
                        </div>
                        <button
                            onClick={() => setIsExpanded(!isExpanded)}
                            className="text-indigo-600 hover:text-indigo-800 text-sm font-medium transition-colors"
                        >
                            {isExpanded ? 'Show Less' : 'Show More'}
                        </button>
                    </div>

                    {agency.cfr_references && agency.cfr_references.length > 0 && (
                        <div className="mt-4">
                            <div className="flex items-center justify-between mb-2">
                                <h4 className="text-sm font-semibold text-gray-700">CFR References:</h4>
                                {isExpanded && !loadingWordCounts && Object.keys(wordCounts).length > 0 && (
                                    <div className="text-xs text-gray-500">
                                        {aggregatedTotals.chaptersWithData}/{aggregatedTotals.totalChapters} chapters with data
                                    </div>
                                )}
                            </div>
                            <div className="flex flex-wrap gap-2">
                                {agency.cfr_references.slice(0, isExpanded ? agency.cfr_references.length : 3).map((ref, index) => (
                                    <div key={index} className="cfr-badge text-white text-xs px-3 py-1 rounded-full">
                                        Title {ref.title}
                                        {ref.chapter && ` - Chapter ${ref.chapter}`}
                                        {ref.subchapter && ` - Subchapter ${ref.subchapter}`}
                                        {ref.part && ` - Part ${ref.part}`}
                                    </div>
                                ))}
                                {!isExpanded && agency.cfr_references.length > 3 && (
                                    <div className="text-gray-500 text-xs px-3 py-1 rounded-full bg-gray-200">
                                        +{agency.cfr_references.length - 3} more
                                    </div>
                                )}
                            </div>
                            
                            {isExpanded && (
                                <div className="expand-content mt-3 space-y-2">
                                    {/* AI Summary Section */}
                                    <div className="mb-4">
                                        {loadingAISummary && (
                                            <div className="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg border border-emerald-200">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-5 h-5 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin"></div>
                                                    <div>
                                                        <div className="text-emerald-700 font-medium">AI Analysis in Progress</div>
                                                        <div className="text-emerald-600 text-sm">Generating agency insights...</div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {!loadingAISummary && aiSummary && (
                                            <div className="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg border border-emerald-200 shadow-sm">
                                                <div className="flex items-center gap-2 mb-3">
                                                    <svg className="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                                    </svg>
                                                    <span className="text-sm font-semibold text-emerald-800">AI-Powered Analysis</span>
                                                    <span className="text-xs text-emerald-600 ml-auto">
                                                        Generated {new Date(aiSummary.generated_at).toLocaleTimeString()}
                                                    </span>
                                                </div>
                                                
                                                <div className="space-y-3">
                                                    {/* Summary */}
                                                    <div>
                                                        <div className="text-sm font-medium text-emerald-700 mb-1">Agency Overview</div>
                                                        <div className="text-sm text-gray-700 leading-relaxed">
                                                            {aiSummary.summary}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Key Responsibilities */}
                                                    {aiSummary.key_responsibilities && aiSummary.key_responsibilities.length > 0 && (
                                                        <div>
                                                            <div className="text-sm font-medium text-emerald-700 mb-2">Key Responsibilities</div>
                                                            <div className="space-y-1">
                                                                {aiSummary.key_responsibilities.map((responsibility, index) => (
                                                                    <div key={index} className="flex items-start gap-2">
                                                                        <svg className="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                                        </svg>
                                                                        <span className="text-sm text-gray-700">{responsibility}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Regulatory Scope */}
                                                    <div>
                                                        <div className="text-sm font-medium text-emerald-700 mb-1">Regulatory Scope</div>
                                                        <div className="text-sm text-gray-700 leading-relaxed">
                                                            {aiSummary.regulatory_scope}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {!loadingAISummary && !aiSummary && (
                                            <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                                <div className="flex items-center gap-2 text-gray-500">
                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                    <span className="text-sm">AI analysis unavailable</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    {/* Aggregated Totals Section */}
                                    {!loadingWordCounts && Object.keys(wordCounts).length > 0 && (
                                        <div className="mb-4 p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg border border-purple-200 shadow-sm">
                                            <div className="flex items-center gap-2 mb-3">
                                                <svg className="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                                </svg>
                                                <span className="text-sm font-semibold text-purple-800">Agency-Wide Statistics</span>
                                            </div>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                <div className="text-center p-2 bg-white rounded border border-purple-100">
                                                    <div className="text-lg font-bold text-purple-700">
                                                        {aggregatedTotals.totalWords.toLocaleString()}
                                                    </div>
                                                    <div className="text-xs text-purple-600">Total Words</div>
                                                </div>
                                                <div className="text-center p-2 bg-white rounded border border-purple-100">
                                                    <div className="text-lg font-bold text-purple-700">
                                                        {aggregatedTotals.totalCharacters.toLocaleString()}
                                                    </div>
                                                    <div className="text-xs text-purple-600">Total Characters</div>
                                                </div>
                                                <div className="text-center p-2 bg-white rounded border border-purple-100">
                                                    <div className="text-lg font-bold text-purple-700">
                                                        {aggregatedTotals.chaptersWithData}
                                                    </div>
                                                    <div className="text-xs text-purple-600">Chapters with Data</div>
                                                </div>
                                                <div className="text-center p-2 bg-white rounded border border-purple-100">
                                                    <div className="text-lg font-bold text-purple-700">
                                                        {aggregatedTotals.reservedChapters}
                                                    </div>
                                                    <div className="text-xs text-purple-600">Reserved Chapters</div>
                                                </div>
                                            </div>
                                            {aggregatedTotals.chaptersWithData < aggregatedTotals.totalChapters && (
                                                <div className="mt-2 text-xs text-gray-600 text-center">
                                                    {aggregatedTotals.totalChapters - aggregatedTotals.chaptersWithData} chapters without word count data
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    {agency.cfr_references.map((ref, index) => {
                                        const wordCountKey = `${ref.title}-${ref.chapter}`;
                                        const wordCount = wordCounts[wordCountKey];
                                        
                                        return (
                                            <div key={index} className="bg-gray-50 p-3 rounded text-sm">
                                                <div className="font-medium text-gray-700">
                                                    Title {ref.title}
                                                    {ref.name && ` - ${ref.name}`}
                                                </div>
                                                
                                                {/* Word Count Information */}
                                                {loadingWordCounts && (
                                                    <div className="text-gray-500 mt-1 text-xs">Loading word count...</div>
                                                )}
                                                
                                                {!loadingWordCounts && wordCount && (
                                                    <div className="mt-2 p-2 bg-blue-50 rounded border border-blue-200">
                                                        <div className="text-xs font-medium text-blue-800 mb-1">Chapter Statistics:</div>
                                                        <div className="grid grid-cols-2 gap-2 text-xs text-blue-700">
                                                            <div>
                                                                <span className="font-medium">Words:</span> {wordCount.word_count?.toLocaleString() || 'N/A'}
                                                            </div>
                                                            <div>
                                                                <span className="font-medium">Characters:</span> {wordCount.character_count?.toLocaleString() || 'N/A'}
                                                            </div>
                                                            <div>
                                                                <span className="font-medium">Chapter:</span> {wordCount.chapter_identifier || ref.chapter}
                                                            </div>
                                                            <div>
                                                                <span className="font-medium">Heading:</span> {wordCount.chapter_heading || 'N/A'}
                                                            </div>
                                                        </div>
                                                        {wordCount.downloaded_at && (
                                                            <div className="text-xs text-blue-600 mt-1">
                                                                Downloaded: {new Date(wordCount.downloaded_at).toLocaleDateString()}
                                                            </div>
                                                        )}
                                                        {wordCount.is_reserved && (
                                                            <div className="text-xs text-orange-600 mt-1 font-medium">
                                                                ⚠️ Reserved Chapter
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                
                                                {!loadingWordCounts && !wordCount && ref.chapter && (
                                                    <div className="text-gray-500 mt-1 text-xs italic">
                                                        No word count data available for this chapter
                                                    </div>
                                                )}
                                                
                                                {/* Original Title Information */}
                                                {ref.latest_amended_on && (
                                                    <div className="text-gray-600 mt-2">
                                                        <span className="font-medium">Latest Amended:</span> {new Date(ref.latest_amended_on).toLocaleDateString()}
                                                    </div>
                                                )}
                                                {ref.latest_issue_date && (
                                                    <div className="text-gray-600">
                                                        <span className="font-medium">Latest Issue:</span> {new Date(ref.latest_issue_date).toLocaleDateString()}
                                                    </div>
                                                )}
                                                {ref.up_to_date_as_of && (
                                                    <div className="text-gray-600">
                                                        <span className="font-medium">Up to Date As:</span> {new Date(ref.up_to_date_as_of).toLocaleDateString()}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    )}

                    <div className="mt-4 pt-4 border-t border-gray-200">
                        <div className="flex justify-between text-xs text-gray-500">
                            <span>ID: {agency.id}</span>
                            <span>Updated: {new Date(agency.updated_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>
            );
        };

        // Search Component
        const SearchBar = ({ slug, name, onSlugChange, onNameChange, onSearch }) => {
            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    onSearch();
                }
            };

            return (
                <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 className="text-lg font-semibold text-gray-900 mb-4">Search Agencies</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                Search by Slug
                            </label>
                            <input
                                type="text"
                                value={slug}
                                onChange={(e) => onSlugChange(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Enter agency slug..."
                                className="search-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                Search by Name
                            </label>
                            <input
                                type="text"
                                value={name}
                                onChange={(e) => onNameChange(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Enter agency name..."
                                className="search-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                        </div>
                    </div>
                    <div className="mt-4 flex gap-3">
                        <button
                            onClick={onSearch}
                            className="px-6 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors"
                        >
                            Search
                        </button>
                        <button
                            onClick={() => {
                                onSlugChange('');
                                onNameChange('');
                                onSearch();
                            }}
                            className="px-6 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            Clear
                        </button>
                    </div>
                </div>
            );
        };

        // Loading Component
        const LoadingSpinner = () => (
            <div className="flex justify-center items-center py-12">
                <div className="loading-spinner"></div>
            </div>
        );

        // Error Component
        const ErrorMessage = ({ error, onRetry }) => (
            <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                <div className="text-red-600 mb-4">
                    <svg className="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h3 className="text-lg font-semibold text-red-800 mb-2">Error Loading Agencies</h3>
                <p className="text-red-600 mb-4">{error.message || 'Failed to load agencies data. Please try again.'}</p>
                <button
                    onClick={onRetry}
                    className="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-colors"
                >
                    Retry
                </button>
            </div>
        );

        // Main App Component
        const App = () => {
            const [agencies, setAgencies] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [slug, setSlug] = useState('');
            const [name, setName] = useState('');

            const fetchAgencies = async () => {
                setLoading(true);
                setError(null);
                try {
                    const data = await apiService.getAgencies(slug, name);
                    setAgencies(data);
                } catch (err) {
                    setError(err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchAgencies();
            }, []);

            const handleSearch = () => {
                fetchAgencies();
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900">eCFR Agencies Directory</h1>
                                    <p className="text-gray-600 mt-1">Browse and search U.S. government agencies</p>
                                </div>
                                <div className="text-sm text-gray-500">
                                    {agencies.length} agencies found
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {/* Search Bar */}
                        <SearchBar
                            slug={slug}
                            name={name}
                            onSlugChange={setSlug}
                            onNameChange={setName}
                            onSearch={handleSearch}
                        />

                        {/* Content Area */}
                        <div className="space-y-4">
                            {loading && <LoadingSpinner />}
                            
                            {error && <ErrorMessage error={error} onRetry={fetchAgencies} />}
                            
                            {!loading && !error && agencies.length === 0 && (
                                <div className="bg-white rounded-lg shadow-md p-8 text-center">
                                    <div className="text-gray-400 mb-4">
                                        <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <h3 className="text-lg font-medium text-gray-900 mb-2">No agencies found</h3>
                                    <p className="text-gray-600">Try adjusting your search criteria or clear the filters to see all agencies.</p>
                                </div>
                            )}
                            
                            {!loading && !error && agencies.map((agency) => (
                                <AgencyCard key={agency.id} agency={agency} />
                            ))}
                        </div>
                    </main>

                    {/* Footer */}
                    <footer className="bg-white border-t border-gray-200 mt-12">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                            <div className="text-center text-sm text-gray-500">
                                <p>eCFR Agencies Directory - Powered by FastAPI & React</p>
                                <p className="mt-1">Data sourced from the Electronic Code of Federal Regulations</p>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>